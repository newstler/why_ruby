<%# Set page title %>
<% content_for(:title) { post_meta_title(@post) } %>

<%# Override meta tags for this post %>
<% content_for :head do %>
  <!-- SEO Meta Tags -->
  <meta name="description" content="<%= post_meta_description(@post) %>">
  <meta name="keywords" content="<%= post_meta_keywords(@post) %>">
  <% if post_meta_author(@post).present? %>
    <meta name="author" content="<%= post_meta_author(@post) %>">
  <% end %>
  <link rel="canonical" href="<%= post_url_for(@post) %>">
  
  <!-- Open Graph / Facebook Meta Tags -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="<%= post_url_for(@post) %>">
  <meta property="og:title" content="<%= full_page_title(post_meta_title(@post)) %>">
  <meta property="og:description" content="<%= post_meta_description(@post) %>">
  <meta property="og:image" content="<%= post_meta_image_url(@post) %>">
  <meta property="og:site_name" content="<%= t('meta.site.name') %>">
  <meta property="og:locale" content="<%= I18n.locale.to_s.gsub('-', '_') %>">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="<%= post_url_for(@post) %>">
  <meta name="twitter:title" content="<%= full_page_title(post_meta_title(@post)) %>">
  <meta name="twitter:description" content="<%= post_meta_description(@post) %>">
  <meta name="twitter:image" content="<%= post_meta_image_url(@post) %>">
  <meta name="twitter:site" content="<%= t('meta.social.twitter_site') %>">
  <meta name="twitter:creator" content="<%= t('meta.social.twitter_creator') %>">
<% end %>

<%= turbo_stream_from "post_#{@post.id}" %>

<div class="max-w-4xl mx-auto">
  <article class="bg-white shadow rounded-lg p-4 md:p-8 mb-8 <%= 'unpublished-post' unless @post.published? %>">
    <!-- Draft label for unpublished posts -->
    <% unless @post.published? %>
      <div class="mb-4">
        <span class="inline-flex items-center px-3 py-1 rounded-md text-sm font-medium bg-gray-200 text-gray-700">
          <%= t('posts.draft') %>
        </span>
      </div>
    <% end %>
    
    <!-- Post Header -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <% unless @post.success_story? %>
            <% if @post.category %>
              <span class="text-sm font-medium text-gray-500"><%= @post.category.name %></span>
            <% else %>
              <span class="text-sm text-gray-400 italic">Uncategorized</span>
            <% end %>
          <% end %>
          <% if @post.link? %>
            <span class="text-sm text-blue-600">üîó External Link</span>
          <% end %>
          <% if @post.needs_admin_review? %>
            <span class="text-sm text-red-600 font-medium">‚ö†Ô∏è Under Review</span>
          <% end %>
        </div>
        
        <% if user_signed_in? && (@post.user.present? && @post.user == current_user || current_user.admin?) %>
          <div class="flex items-center space-x-3">
            <%= link_to edit_post_path(@post), class: "text-sm text-gray-400 hover:text-black flex items-center gap-1.5 transition-colors" do %>
              <%= inline_svg_tag "edit.svg", class: "w-4 h-4" %>
              <span>Edit</span>
            <% end %>
            <%= button_to post_destroy_path(@post), method: :delete, data: { turbo: false }, form: { class: "inline", onsubmit: "return confirm('Are you sure?')" }, class: "text-sm text-gray-400 hover:text-red-600 border-0 bg-transparent cursor-pointer p-0 flex items-center gap-1.5 transition-colors" do %>
              <%= inline_svg_tag "delete.svg", class: "w-4 h-4" %>
              <span>Delete</span>
            <% end %>
          </div>
        <% end %>
      </div>
      
      <h1 class="text-4xl md:text-6xl font-black text-gray-900 mb-8"><%= @post.title %></h1>
    </div>

    <!-- Post Image or Logo -->
    <% if @post.success_story? && @post.logo_svg.present? %>
      <div class="mb-8">
        <div class="h-64 md:h-80 rounded-lg flex justify-center items-center p-12 success-story-show-logo <%= 'grayscale' unless @post.published? %>">
          <%= safe_svg_content(@post.logo_svg) %>
        </div>
      </div>
    <% elsif @post.featured_image.attached? && !@post.link? %>
      <div class="mb-8">
        <div class="aspect-video rounded-lg overflow-hidden <%= 'grayscale' unless @post.published? %>">
          <%= responsive_post_image(@post, size: :medium, css_class: "w-full h-full object-cover", alt: @post.title) %>
        </div>
      </div>
    <% end %>

    <!-- Post Body -->
    <% if @post.success_story? %>
      <div class="prose prose-sm md:prose-lg max-w-none mb-8">
        <%= safe_markdown_content(@post.content) %>
      </div>
    <% elsif @post.link? %>
      <div class="mb-8">
        <div class="bg-white border border-gray-300 rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
          <% if @post.featured_image.attached? %>
            <div class="aspect-video">
              <%= post_image_tag(@post, size: :thumb, css_class: "w-full h-full object-cover", alt: @post.title) %>
            </div>
          <% end %>
          <div class="p-6">
            <% if @post.summary.present? %>
              <p class="text-gray-600 mb-4"><%= @post.summary %></p>
            <% end %>
            <div class="flex items-center justify-between">
              <p class="text-blue-600 text-sm truncate flex-1 mr-4"><%= @post.url %></p>
              <%= link_to "Visit Link", safe_external_url(@post.url), target: "_blank", rel: "noopener", 
                  class: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex-shrink-0" %>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="prose prose-sm md:prose-lg max-w-none mb-8">
        <%= safe_markdown_content(@post.content) %>
      </div>
    <% end %>

    <!-- Post Footer -->
    <hr class="mt-8 mb-6 -mx-4 md:-mx-8 border-gray-100">
    
    <div class="pt-0">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-3">
            <% if @post.user.present? %>
              <% if @post.user.avatar_url.present? %>
                <%= link_to user_path(@post.user), class: "text-base font-medium text-gray-900 hover:text-gray-700" do %>
                  <%= image_tag @post.user.avatar_url, alt: @post.user.display_name, class: "h-10 w-10 rounded-full" %>
                <% end %>
              <% end %>
              <div>
                <%= link_to @post.user.display_name, user_path(@post.user), class: "text-base font-medium text-gray-900 hover:text-gray-700" %>
                <p class="text-sm text-gray-500"><%= format_post_date(@post.created_at) %></p>
              </div>
            <% else %>
              <div>
                <span class="text-base font-medium text-gray-400 italic">[Deleted User]</span>
                <p class="text-sm text-gray-500"><%= format_post_date(@post.created_at) %></p>
              </div>
            <% end %>
          </div>
        </div>
        
        <div class="flex items-center gap-4">
          <% if !@post.success_story? && @post.tags.any? %>
            <div class="flex flex-wrap gap-2 justify-end">
              <% @post.tags.each do |tag| %>
                <%= render 'shared/tag', tag: tag, light: true, class: 'text-sm' %>
              <% end %>
            </div>
          <% end %>
          
          <% if user_signed_in? && current_user.trusted? && (@post.user.nil? || current_user != @post.user) %>
            <button type="button" onclick="document.getElementById('report-modal').classList.remove('hidden')" class="text-sm text-gray-600 hover:text-gray-900">
              Report
            </button>
          <% end %>
        </div>
      </div>
    </div>
  </article>

  <!-- Comments Section -->
  <section class="bg-white shadow rounded-lg p-4 md:p-8" data-controller="comment-highlight">
    <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6">Comments</h2>
    
    <div id="comments" class="space-y-4 md:space-y-6">
      <% @comments.each do |comment| %>
        <%= render "comments/comment", comment: comment %>
      <% end %>
    </div>
    
    <!-- New Comment Form -->
    <% if user_signed_in? %>
      <%= render "comments/form", post: @post, comment: Comment.new %>
    <% else %>
      <div class="mt-8 space-y-4">
        <p class="text-gray-600"><%= t('comments.sign_in_to_comment') %></p>
        <%= render "shared/github_signin_button" %>
      </div>
    <% end %>
  </section>
</div>

<!-- Report Modal -->
<% if user_signed_in? && current_user.trusted? %>
  <div id="report-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Report Post</h3>
      <%= form_with model: [@post, Report.new], local: true do |form| %>
        <div class="mb-4">
          <%= form.label :reason, class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :reason, options_for_select(Report.reasons.map {|key, value| [key.humanize, key]}), { prompt: "Select a reason" }, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" %>
        </div>
        <div class="mb-4">
          <%= form.label :description, "Additional details (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_area :description, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" %>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="document.getElementById('report-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
          <%= form.submit "Submit Report", class: "px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 cursor-pointer" %>
        </div>
      <% end %>
    </div>
  </div>
<% end %> 