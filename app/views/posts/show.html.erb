<%= turbo_stream_from "post_#{@post.id}" %>

<div class="max-w-4xl mx-auto">
  <article class="bg-white shadow rounded-lg p-4 md:p-8 mb-8">
    <!-- Post Header -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <% if @post.category %>
            <span class="text-sm font-medium text-gray-500"><%= @post.category.name %></span>
          <% else %>
            <span class="text-sm text-gray-400 italic">Uncategorized</span>
          <% end %>
          <% if @post.link? %>
            <span class="text-sm text-blue-600">üîó External Link</span>
          <% end %>
          <% if @post.needs_admin_review? %>
            <span class="text-sm text-red-600 font-medium">‚ö†Ô∏è Under Review</span>
          <% end %>
        </div>
        
        <div class="flex items-center space-x-2">
          <% if user_signed_in? && (@post.user.present? && @post.user == current_user || current_user.admin?) %>
            <%= link_to "Edit", edit_post_path(@post), class: "text-sm text-gray-600 hover:text-gray-900" %>
            <%= link_to "Delete", post_path(@post), method: :delete, data: { confirm: "Are you sure?" }, class: "text-sm text-red-600 hover:text-red-900" %>
          <% end %>
        </div>
      </div>
      
      <h1 class="text-4xl md:text-6xl font-black text-gray-900 mb-8"><%= @post.title %></h1>
    </div>

    <!-- Post Body -->
    <% if @post.link? %>
      <div class="mb-8">
        <div class="bg-white border border-gray-300 rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
          <% if @post.title_image_url.present? %>
            <div class="aspect-w-16 aspect-h-9">
              <%= image_tag @post.title_image_url, alt: @post.title, class: "w-full h-64 object-cover" %>
            </div>
          <% end %>
          <div class="p-6">
            <% if @post.summary.present? %>
              <p class="text-gray-600 mb-4"><%= @post.summary %></p>
            <% end %>
            <div class="flex items-center justify-between">
              <p class="text-blue-600 text-sm truncate flex-1 mr-4"><%= @post.url %></p>
              <%= link_to "Visit Link", @post.url, target: "_blank", rel: "noopener", 
                  class: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex-shrink-0" %>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="prose prose-sm md:prose-lg max-w-none mb-8">
        <%= raw markdown_to_html(@post.content) %>
      </div>
    <% end %>

    <!-- Post Footer -->
    <hr class="mt-8 mb-6 -mx-4 md:-mx-8 border-gray-100">
    
    <div class="pt-0">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <% if @post.user.present? %>
              <% if @post.user.avatar_url.present? %>
                <%= link_to user_path(@post.user), class: "text-sm font-medium text-gray-900 hover:text-gray-700" do %>
                  <%= image_tag @post.user.avatar_url, alt: @post.user.username, class: "h-10 w-10 rounded-full" %>
                <% end %>
              <% end %>
              <div>
                <%= link_to @post.user.username, user_path(@post.user), class: "text-sm font-medium text-gray-900 hover:text-gray-700" %>
                <p class="text-xs text-gray-500"><%= format_post_date(@post.created_at) %></p>
              </div>
            <% else %>
              <div>
                <span class="text-sm font-medium text-gray-400 italic">[Deleted User]</span>
                <p class="text-xs text-gray-500"><%= format_post_date(@post.created_at) %></p>
              </div>
            <% end %>
          </div>
        </div>
        
        <% if user_signed_in? && current_user.trusted? && (@post.user.nil? || current_user != @post.user) %>
          <button type="button" onclick="document.getElementById('report-modal').classList.remove('hidden')" class="text-sm text-gray-600 hover:text-gray-900">
            Report
          </button>
        <% end %>
      </div>
      
      <% if @post.tags.any? %>
        <div class="flex flex-wrap gap-1 md:gap-2 mb-2 md:mb-0">
          <% @post.tags.each do |tag| %>
            <%= link_to tag.name, tag_path(tag), class: "text-xs md:text-sm bg-gray-200 text-gray-700 px-2 md:px-3 py-1 rounded-full hover:bg-gray-300" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </article>

  <!-- Comments Section -->
  <section class="bg-white shadow rounded-lg p-4 md:p-8">
    <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6">Comments</h2>
    
    <% if user_signed_in? %>
      <%= form_with model: [@post, Comment.new], local: true, class: "mb-8" do |form| %>
        <div class="mb-4">
          <%= form.text_area :body, rows: 4, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500", placeholder: "Write a comment..." %>
        </div>
        <%= form.submit "Post Comment", class: "px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 cursor-pointer" %>
      <% end %>
    <% else %>
      <p class="text-gray-600 mb-8">
        <%= button_to "Sign in", user_github_omniauth_authorize_path, method: :post, data: { turbo: false }, class: "text-red-600 hover:text-red-800 underline bg-transparent border-0 p-0 cursor-pointer" %> to leave a comment.
      </p>
    <% end %>
    
    <div class="space-y-4 md:space-y-6">
      <% @comments.each do |comment| %>
        <div class="flex space-x-2 md:space-x-3">
          <% if comment.user.present? && comment.user.avatar_url.present? %>
            <%= image_tag comment.user.avatar_url, alt: comment.user.username, class: "h-8 w-8 md:h-10 md:w-10 rounded-full flex-shrink-0" %>
          <% end %>
          <div class="flex-1">
            <div class="bg-gray-50 rounded-lg px-3 py-2 md:px-4 md:py-3">
              <div class="flex flex-wrap items-start justify-between gap-x-2 gap-y-1 mb-2">
                <h4 class="text-sm font-medium text-gray-900">
                  <% if comment.user.present? %>
                    <%= link_to comment.user.username, user_path(comment.user), class: "hover:text-gray-700" %>
                  <% else %>
                    <span class="text-gray-400 italic">[Deleted User]</span>
                  <% end %>
                </h4>
                <div class="flex items-center space-x-2 text-xs">
                  <span class="text-gray-500">
                    <%= format_comment_date(comment.created_at) %>
                  </span>
                  <% if user_signed_in? && (comment.user == current_user || current_user.admin?) %>
                    <%= link_to "Delete", post_comment_path(@post, comment), method: :delete, data: { confirm: "Are you sure?" }, class: "text-red-600 hover:text-red-800" %>
                  <% end %>
                </div>
              </div>
              <p class="text-sm md:text-base text-gray-700 whitespace-pre-wrap"><%= comment.body %></p>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </section>
</div>

<!-- Report Modal -->
<% if user_signed_in? && current_user.trusted? %>
  <div id="report-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Report Post</h3>
      <%= form_with model: [@post, Report.new], local: true do |form| %>
        <div class="mb-4">
          <%= form.label :reason, class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :reason, options_for_select(Report.reasons.map {|key, value| [key.humanize, key]}), { prompt: "Select a reason" }, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" %>
        </div>
        <div class="mb-4">
          <%= form.label :description, "Additional details (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_area :description, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" %>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="document.getElementById('report-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
          <%= form.submit "Submit Report", class: "px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 cursor-pointer" %>
        </div>
      <% end %>
    </div>
  </div>
<% end %> 