<%= form_with model: post, data: { controller: "content-type", post_id: post.persisted? ? post.id : nil } do |form| %>
  <% if post.errors.any? %>
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
      <div class="flex">
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            There were <%= pluralize(post.errors.count, "error") %> with your submission
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside">
              <% post.errors.full_messages.each do |message| %>
                <li>
                  <%= message %>
                  <% if message.include?("already been posted") && post.duplicate_post %>
                    - <%= link_to "View \"#{post.duplicate_post.title}\"", 
                        post.duplicate_post.link? ? post_path(post.duplicate_post) : post_link_url(post.duplicate_post), 
                        class: "text-blue-600 hover:text-blue-800 underline font-medium" %>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="space-y-6">
    <div>
      <p class="text-sm font-medium text-gray-700 mb-2">Post Type</p>
      <div class="space-y-4">
        <label class="flex items-start">
          <%= radio_button_tag 'content_type', 'article', post.article? || post.new_record?, class: "mt-1 mr-2", data: { action: "change->content-type#toggle" } %>
          <div>
            <span class="font-medium">Article</span>
            <p class="text-sm text-gray-500">Write original content with markdown support</p>
          </div>
        </label>
        <label class="flex items-start">
          <%= radio_button_tag 'content_type', 'link', post.link?, class: "mt-1 mr-2", data: { action: "change->content-type#toggle" } %>
          <div>
            <span class="font-medium">External Link</span>
            <p class="text-sm text-gray-500">Share a link to external content</p>
          </div>
        </label>
      </div>
    </div>

    <div id="title-field" class="<%= 'hidden' if post.link? %>" data-content-type-target="titleField">
      <%= form.label :title, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_field :title, 
          class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500", 
          placeholder: "Enter a descriptive title",
          data: { "link-metadata-target": "title" } %>
    </div>

    <div>
      <%= form.label :category_id, "Category", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.select :category_id, options_for_select(Category.ordered.pluck(:name, :id), post.category_id), { prompt: "Select a category" }, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" %>
    </div>

    <div id="article-fields" class="<%= 'hidden' if post.link? %>" data-controller="markdown-preview" data-content-type-target="articleFields">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <div class="flex items-center justify-between mb-2">
            <%= form.label :content, "Content (Markdown supported)", class: "block text-sm font-medium text-gray-700" %>
            <button type="button" class="lg:hidden text-sm text-red-600 hover:text-red-800" data-action="click->markdown-preview#togglePreview">
              Toggle Preview
            </button>
          </div>
          <%= form.text_area :content, rows: 20, 
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 font-mono text-sm", 
              placeholder: "Write your content here...",
              data: { 
                "markdown-preview-target": "input",
                "action": "input->markdown-preview#updatePreview"
              } %>
        </div>
        
        <div class="hidden lg:block" data-markdown-preview-target="previewContainer">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Preview</h4>
          <div class="prose prose-sm max-w-none border border-gray-300 rounded-md p-4 bg-white overflow-y-auto" data-markdown-preview-target="preview">
            <p class="text-gray-500">Preview will appear here as you type...</p>
          </div>
        </div>
      </div>
      <p class="mt-2 text-sm text-gray-500">You can use Markdown formatting. Code blocks are supported with syntax highlighting.</p>
      
      <div class="mt-4">
        <%= form.label :title_image_url, "Title Image URL (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.text_field :title_image_url, 
            class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500", 
            placeholder: "https://example.com/image.jpg",
            data: { "link-metadata-target": "image" } %>
      </div>
    </div>

    <div id="link-fields" class="<%= 'hidden' unless post.link? %>" data-controller="link-metadata" data-content-type-target="linkFields">
      <div class="space-y-4">
        <div>
          <%= form.label :url, "URL", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_field :url, 
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500", 
              placeholder: "https://example.com/article",
              data: { 
                "link-metadata-target": "url",
                "action": "paste->link-metadata#onUrlPaste input->link-metadata#onUrlInput"
              } %>
                  </div>
          
          <div class="hidden" data-link-metadata-target="duplicateWarning">
            <!-- Duplicate warning will be inserted here -->
          </div>
          
          <div class="hidden" data-link-metadata-target="loading">
          <div class="text-center py-4">
            <div class="inline-flex items-center">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="text-gray-600">Fetching link metadata...</span>
            </div>
          </div>
        </div>
        
        <div class="<%= post.link? && post.persisted? ? '' : 'hidden' %>" data-link-metadata-target="preview">
          <% if post.link? && post.persisted? %>
            <h4 class="text-sm font-medium text-gray-700 mb-2">Preview:</h4>
            <div class="bg-white border border-gray-300 rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
              <% if post.title_image_url.present? %>
                <div class="aspect-w-16 aspect-h-9">
                  <%= image_tag post.title_image_url, alt: post.title, class: "w-full h-48 object-cover" %>
                </div>
              <% end %>
              <div class="p-4">
                <h3 class="font-semibold text-lg mb-2"><%= post.title %></h3>
                <p class="text-gray-600 text-sm line-clamp-2"><%= post.summary.presence || 'No description available' %></p>
                <p class="text-blue-600 text-sm mt-2 truncate"><%= post.url %></p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div>
      <%= form.label :tag_ids, "Tags", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <%= form.collection_check_boxes :tag_ids, Tag.all, :id, :name do |b| %>
          <label class="flex items-center space-x-2">
            <%= b.check_box(class: "rounded border-gray-300 text-red-600 focus:ring-red-500") %>
            <span class="text-sm"><%= b.text %></span>
          </label>
        <% end %>
      </div>
    </div>

    <div data-controller="markdown-preview">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <div class="flex items-center justify-between mb-2">
            <%= form.label :summary, "Summary (Markdown supported)", class: "block text-sm font-medium text-gray-700" %>
            <button type="button" class="lg:hidden text-sm text-red-600 hover:text-red-800" data-action="click->markdown-preview#togglePreview">
              Toggle Preview
            </button>
          </div>
          <%= form.text_area :summary, rows: 5,
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 font-mono text-sm", 
              placeholder: "Enter a brief summary of your post (optional). If left blank, an AI-generated summary will be created.",
              data: { 
                "markdown-preview-target": "input",
                "action": "input->markdown-preview#updatePreview"
              } %>
          <p class="mt-1 text-sm text-gray-500">A 2-3 sentence summary that captures the key points. Leave blank to auto-generate.</p>
        </div>
        
        <div class="hidden lg:block" data-markdown-preview-target="previewContainer">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Preview</h4>
          <div class="prose prose-sm max-w-none border border-gray-300 rounded-md p-4 bg-white overflow-y-auto min-h-[120px]" data-markdown-preview-target="preview" style="height: 120px;">
            <p class="text-gray-500">Preview will appear here as you type...</p>
          </div>
        </div>
      </div>
    </div>

    <div>
      <label class="flex items-center space-x-2">
        <%= form.check_box :published, class: "rounded border-gray-300 text-red-600 focus:ring-red-500" %>
        <span class="text-sm font-medium text-gray-700">Publish immediately</span>
      </label>
      <p class="mt-1 text-sm text-gray-500">If unchecked, content will be saved as a draft</p>
    </div>

    <div class="flex justify-end space-x-4">
      <%= link_to "Cancel", posts_path, class: "px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" %>
      <%= form.submit post.new_record? ? "Create Post" : "Update Post", 
          class: "px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",
          data: { "turbo-submits-with": post.new_record? ? "Creating..." : "Updating...", disable_with: post.new_record? ? "Creating..." : "Updating..." } %>
    </div>
  </div>
<% end %> 