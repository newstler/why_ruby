<%= form_with model: post, data: { controller: "content-type", post_id: post.persisted? ? post.id : nil } do |form| %>
  <% if post.errors.any? %>
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
      <div class="flex">
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            There were <%= pluralize(post.errors.count, "error") %> with your submission
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside">
              <% post.errors.full_messages.each do |message| %>
                <li>
                  <%= message %>
                  <% if message.include?("already been posted") && post.duplicate_post %>
                    - <%= link_to "View \"#{post.duplicate_post.title}\"", 
                        post.duplicate_post.link? ? post_path(post.duplicate_post) : post_link_url(post.duplicate_post), 
                        class: "text-blue-600 hover:text-blue-800 underline font-medium" %>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="space-y-6">
    <% if post.persisted? %>
      <div class="bg-gray-100 rounded-lg p-4 mb-6">
        <p class="text-sm text-gray-600">
          <span class="font-medium">Post Type:</span> 
          <span class="capitalize"><%= post.post_type.humanize %></span>
          <span class="text-xs text-gray-500 ml-2">(cannot be changed)</span>
        </p>
      </div>
      <%= form.hidden_field :post_type, value: post.post_type %>
    <% else %>
      <div>
        <p class="text-sm font-medium text-gray-700 mb-2">Post Type</p>
        <div class="grid grid-cols-3 gap-2 w-full" role="group">
        <button type="button"
                data-type="article"
                data-action="click->content-type#selectType"
                data-content-type-target="typeButton"
                class="<%= post.article? || (post.new_record? && !post.success_story?) ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %> px-4 py-3 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 cursor-pointer">
          <div class="flex flex-col items-center">
            <span class="font-medium">Article</span>
            <span class="text-xs mt-0.5 opacity-75">Original content</span>
          </div>
        </button>
        <button type="button"
                data-type="link"
                data-action="click->content-type#selectType"
                data-content-type-target="typeButton"
                class="<%= post.link? ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %> px-4 py-3 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 cursor-pointer">
          <div class="flex flex-col items-center">
            <span class="font-medium">External Link</span>
            <span class="text-xs mt-0.5 opacity-75">Share a link</span>
          </div>
        </button>
        <button type="button"
                data-type="success_story"
                data-action="click->content-type#selectType"
                data-content-type-target="typeButton"
                class="<%= post.success_story? ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %> px-4 py-3 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 cursor-pointer">
          <div class="flex flex-col items-center">
            <span class="font-medium">Success Story</span>
            <span class="text-xs mt-0.5 opacity-75">With logo</span>
          </div>
        </button>
        </div>
        <%= form.hidden_field :post_type, value: post.post_type.presence || 'article' %>
      </div>
    <% end %>

    <div id="category-field" class="<%= 'hidden' if post.success_story? %>" data-content-type-target="categoryField">
      <%= form.label :category_id, "Category", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.select :category_id, options_for_select(Category.ordered.pluck(:name, :id), post.category_id), { prompt: "Select a category" }, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500", data: { "content-type-target": "categorySelect" } %>
    </div>

    <div id="link-fields" class="<%= 'hidden' unless post.link? %>" data-controller="link-metadata" data-content-type-target="linkFields">
      <div class="space-y-4">
        <div>
          <%= form.label :url, "URL", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_field :url, 
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500", 
              placeholder: "https://example.com/article",
              data: { 
                "link-metadata-target": "url",
                "content-type-target": "urlInput",
                "action": "paste->link-metadata#onUrlPaste input->link-metadata#onUrlInput"
              } %>
                  </div>
          
          <div class="hidden" data-link-metadata-target="duplicateWarning">
            <!-- Duplicate warning will be inserted here -->
          </div>
          
          <div class="hidden" data-link-metadata-target="loading">
          <div class="text-center py-4">
            <div class="inline-flex items-center">
              <%= inline_svg_tag "spinner.svg", class: "animate-spin -ml-1 mr-3 h-5 w-5 text-red-600" %>
              <span class="text-gray-600">Fetching link metadata...</span>
            </div>
          </div>
        </div>
        
        <div class="<%= post.link? && post.persisted? ? '' : 'hidden' %>" data-link-metadata-target="preview">
          <% if post.link? && post.persisted? %>
            <h4 class="text-sm font-medium text-gray-700 mb-2">Preview:</h4>
            <div class="bg-white border border-gray-300 rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
              <% if post.title_image_url.present? %>
                <div class="aspect-w-16 aspect-h-9">
                  <%= image_tag post.title_image_url, alt: post.title, class: "w-full h-48 object-cover" %>
                </div>
              <% end %>
              <div class="p-4">
                <h3 class="font-semibold text-lg mb-2"><%= post.title %></h3>
                <p class="text-gray-600 text-sm line-clamp-2"><%= post.summary.presence || 'No description available' %></p>
                <p class="text-blue-600 text-sm mt-2 truncate"><%= post.url %></p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div id="title-field" data-content-type-target="titleField">
      <%= form.label :title, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_field :title, 
          class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500", 
          placeholder: post.success_story? ? "Enter company name" : "Enter a descriptive title",
          data: { "link-metadata-target": "title", "content-type-target": "titleInput" } %>
      <p class="mt-1 text-sm text-gray-500 hidden" data-content-type-target="linkTitleHint">Title will auto-populate from the link, but you can edit it</p>
    </div>
    
    <div id="logo-field" class="<%= 'hidden' unless post.success_story? %>" data-content-type-target="logoField">
      <%= form.label :logo_svg, "Company Logo (SVG)", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <div class="space-y-4">
        <div class="w-full cursor-pointer" 
             data-content-type-target="uploadArea"
             data-action="click->content-type#triggerFileUpload dragover->content-type#handleDragOver drop->content-type#handleDrop dragleave->content-type#handleDragLeave">
          <div class="w-full py-8 px-4 bg-white border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-red-400 hover:text-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500">
            <div class="flex flex-col items-center space-y-2">
              <%= inline_svg_tag "plus.svg", class: "w-8 h-8" %>
              <span class="text-base font-medium">Upload SVG Logo</span>
              <span class="text-sm text-gray-500">Click to browse or drag and drop</span>
            </div>
          </div>
        </div>
        
        <input type="file"
               accept="image/svg+xml,.svg"
               class="hidden"
               data-content-type-target="logoInput"
               data-action="change->content-type#handleSvgUpload">
        <%= form.hidden_field :logo_svg, data: { "content-type-target": "svgContent" } %>
        
        <div class="hidden" data-content-type-target="logoPreviewWrapper">
          <div class="relative bg-gray-50 p-6 rounded-lg border border-gray-200">
            <button type="button"
                    data-action="click->content-type#removeLogo"
                    class="absolute top-2 right-2 p-1 bg-white rounded-full shadow-md hover:shadow-lg transition-shadow cursor-pointer">
              <svg class="w-5 h-5 text-gray-600 hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
            <div class="flex justify-center items-center" data-content-type-target="logoPreview">
              <!-- SVG preview will be inserted here -->
            </div>
          </div>
        </div>
        
        <% if post.persisted? && post.logo_svg.present? %>
          <div data-content-type-target="logoPreviewWrapper">
            <div class="relative bg-gray-50 p-6 rounded-lg border border-gray-200">
              <button type="button"
                      data-action="click->content-type#removeLogo"
                      class="absolute top-2 right-2 p-1 bg-white rounded-full shadow-md hover:shadow-lg transition-shadow cursor-pointer">
                <svg class="w-5 h-5 text-gray-600 hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
              <div class="flex justify-center items-center" data-content-type-target="logoPreview">
                <%= raw post.logo_svg %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div id="image-field" class="<%= 'hidden' if post.link? || post.success_story? %>" data-content-type-target="imageField">
      <%= form.label :title_image_url, "Title Image URL (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_field :title_image_url, 
          class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500", 
          placeholder: "https://example.com/image.jpg",
          data: { "link-metadata-target": "image", "content-type-target": "imageInput" } %>
    </div>

    <div id="article-fields" class="<%= 'hidden' if post.link? %>" data-controller="markdown-preview" data-content-type-target="articleFields">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <div class="flex items-center justify-between mb-2">
            <%= form.label :content, "Content (Markdown supported)", class: "block text-sm font-medium text-gray-700" %>
            <button type="button" class="lg:hidden text-sm text-red-600 hover:text-red-800" data-action="click->markdown-preview#togglePreview">
              Toggle Preview
            </button>
          </div>
          <%= form.text_area :content, rows: 20, 
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 font-mono text-sm", 
              placeholder: "Write your content here...",
              data: { 
                "markdown-preview-target": "input",
                "content-type-target": "contentInput",
                "action": "input->markdown-preview#updatePreview"
              } %>
        </div>
        
        <div class="hidden lg:block" data-markdown-preview-target="previewContainer">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Preview</h4>
          <div class="prose prose-sm max-w-none border border-gray-300 rounded-md p-4 bg-white overflow-y-auto" data-markdown-preview-target="preview">
            <p class="text-gray-500">Preview will appear here as you type...</p>
          </div>
        </div>
      </div>
      <p class="mt-2 text-sm text-gray-500">You can use Markdown formatting. Code blocks are supported with syntax highlighting.</p>
    </div>

    <% 
      # Load tags for existing posts
      existing_tags = if post.persisted? && post.tags.any?
        post.tags.to_a.map { |t| { id: t.id, name: t.name } }
      else
        []
      end
    %>

    <div id="tags-field" class="<%= 'hidden' if post.success_story? %>" data-controller="tag-input" data-content-type-target="tagsField" data-content-type-target="tagsInput" 
         data-tag-input-existing-tags-value='<%= existing_tags.to_json %>'
         data-tag-input-create-new-text-value="<%= t('posts.form.tags.create_new') %>"
         data-tag-input-placeholder-value="<%= t('posts.form.tags.placeholder') %>"
         data-tag-input-placeholder-with-tags-value="<%= t('posts.form.tags.placeholder_with_tags') %>">
      <%= form.label :tag_names, t('posts.form.tags.label'), class: "block text-sm font-medium text-gray-700 mb-2" %>
      <div class="relative">
        <div class="flex flex-wrap items-center gap-1 min-h-[42px] px-3 py-1.5 border border-gray-300 rounded-md focus-within:ring-2 focus-within:ring-red-500 focus-within:border-red-500 cursor-text bg-white"
             data-tag-input-target="container">
          <!-- Tags will be rendered here inline with the input -->
          <div class="tag-input-wrapper flex-1 min-w-[150px]">
            <input type="text" 
                   class="w-full outline-none border-0 p-0 focus:ring-0 text-sm bg-transparent"
                   placeholder="<%= post.tags.empty? ? t('posts.form.tags.placeholder') : t('posts.form.tags.placeholder_with_tags') %>"
                   data-tag-input-target="input"
                   data-action="input->tag-input#handleInput keydown->tag-input#handleKeydown">
          </div>
        </div>
        <%= form.hidden_field :tag_names, 
                              value: post.persisted? ? post.tags.to_a.map(&:name).join(',') : '', 
                              data: { "tag-input-target": "hiddenField" } %>
        
        <div class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto"
             data-tag-input-target="suggestions">
          <!-- Suggestions will be rendered here -->
        </div>
      </div>
      <p class="text-sm text-gray-500 mt-2"><%= t('posts.form.tags.help_text') %></p>
    </div>

    <div data-controller="markdown-preview">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <div class="flex items-center justify-between mb-2">
            <%= form.label :summary, "Summary (Markdown supported)", class: "block text-sm font-medium text-gray-700" %>
            <button type="button" class="lg:hidden text-sm text-red-600 hover:text-red-800" data-action="click->markdown-preview#togglePreview">
              Toggle Preview
            </button>
          </div>
          <%= form.text_area :summary, rows: 5,
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 font-mono text-sm", 
              placeholder: "Enter a brief summary of your post (optional). If left blank, an AI-generated summary will be created.",
              data: { 
                "markdown-preview-target": "input",
                "content-type-target": "summaryInput",
                "action": "input->markdown-preview#updatePreview",
                "link-metadata-target": "summary"
              } %>
          <p class="mt-1 text-sm text-gray-500">A 2-3 sentence summary that captures the key points. Leave blank to auto-generate.</p>
        </div>
        
        <div class="hidden lg:block" data-markdown-preview-target="previewContainer">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Preview</h4>
          <div class="prose prose-sm max-w-none border border-gray-300 rounded-md p-4 bg-white overflow-y-auto min-h-[120px]" data-markdown-preview-target="preview" style="height: 120px;">
            <p class="text-gray-500">Preview will appear here as you type...</p>
          </div>
        </div>
      </div>
    </div>

    <div>
      <label class="flex items-center space-x-2">
        <%= form.check_box :published, class: "rounded border-gray-300 text-red-600 focus:ring-red-500" %>
        <span class="text-sm font-medium text-gray-700">Publish immediately</span>
      </label>
      <p class="mt-1 text-sm text-gray-500">If unchecked, content will be saved as a draft</p>
    </div>

    <div class="flex justify-end space-x-4">
      <%= link_to "Cancel", posts_path, class: "px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" %>
      <%= form.submit post.new_record? ? "Create Post" : "Update Post", 
          class: "px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",
          data: { "turbo-submits-with": post.new_record? ? "Creating..." : "Updating...", disable_with: post.new_record? ? "Creating..." : "Updating..." } %>
    </div>
  </div>
<% end %> 