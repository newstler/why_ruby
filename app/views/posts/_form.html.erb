<%= form_with model: post, url: (post.persisted? ? post_update_path(post) : posts_path), data: { turbo: false, controller: "content-type form-validation", post_id: (post.persisted? ? post.id : nil), "form-validation-post-type-value": post.post_type.presence || 'article' } do |form| %>
  <% if post.errors.any? %>
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
      <div class="flex">
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            There were <%= pluralize(post.errors.count, "error") %> with your submission
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside">
              <% post.errors.full_messages.each do |message| %>
                <li>
                  <%= message %>
                  <% if message.include?("already been posted") && post.duplicate_post %>
                    - <%= link_to "View \"#{post.duplicate_post.title}\"", 
                        post.duplicate_post.link? ? post_link_url(post.duplicate_post) : post_path_for(post.duplicate_post), 
                        class: "text-blue-600 hover:text-blue-800 underline font-medium" %>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="space-y-6">
    <% if post.persisted? %>
      <%= form.hidden_field :post_type, value: post.post_type %>
    <% else %>
      <div>
        <div class="grid grid-cols-3 gap-2 w-full" role="group">
        <button type="button"
                data-type="article"
                data-action="click->content-type#selectType"
                data-content-type-target="typeButton"
                class="<%= post.article? || (post.new_record? && !post.success_story?) ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %> px-4 py-3 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 cursor-pointer">
          <div class="flex flex-col items-center">
            <span class="font-medium">Article</span>
            <span class="text-xs mt-0.5 opacity-75">Original content</span>
          </div>
        </button>
        <button type="button"
                data-type="link"
                data-action="click->content-type#selectType"
                data-content-type-target="typeButton"
                class="<%= post.link? ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %> px-4 py-3 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 cursor-pointer">
          <div class="flex flex-col items-center">
            <span class="font-medium">External Link</span>
            <span class="text-xs mt-0.5 opacity-75">Article, video, presentation...</span>
          </div>
        </button>
        <button type="button"
                data-type="success_story"
                data-action="click->content-type#selectType"
                data-content-type-target="typeButton"
                class="<%= post.success_story? ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %> px-4 py-3 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 cursor-pointer">
          <div class="flex flex-col items-center">
            <span class="font-medium">Success Story</span>
            <span class="text-xs mt-0.5 opacity-75">Powered by Ruby</span>
          </div>
        </button>
        </div>
        <%= form.hidden_field :post_type, value: post.post_type.presence || 'article' %>
      </div>
    <% end %>

    <div id="category-field" class="<%= 'hidden' if post.success_story? %>" data-content-type-target="categoryField">
      <%= form.label :category_id, "Category", class: "block text-sm font-bold text-black mb-2" %>
      <% 
        categories_with_descriptions = Category.regular.ordered.pluck(:name, :id, :description)
        category_options = categories_with_descriptions.map do |name, id, description|
          [name, id, { "data-description" => description }]
        end
      %>
      <%= form.select :category_id, options_for_select(category_options, post.category_id), { prompt: "Select a category..." }, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 #{post.category_id.blank? ? 'placeholder-selected' : ''}", data: { "content-type-target": "categorySelect", "form-validation-target": "requiredField", "action": "change->form-validation#validateForm change->content-type#updateSelectColor change->content-type#updateCategoryHint" } %>
      <p class="mt-2 text-xs text-gray-400 hidden" data-content-type-target="categoryHint">
        <!-- Category description will be displayed here -->
      </p>
    </div>

    <div id="link-fields" class="<%= 'hidden' unless post.link? %>" data-controller="link-metadata" data-content-type-target="linkFields">
      <div class="space-y-4">
        <div>
          <%= form.label :url, "URL", class: "block text-sm font-bold text-black mb-2" %>
          <%= form.text_field :url, 
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 placeholder:text-gray-400", 
              placeholder: "https://example.com/article",
              data: { 
                "link-metadata-target": "url",
                "content-type-target": "urlInput",
                "form-validation-target": "requiredField",
                "action": "paste->link-metadata#onUrlPaste input->link-metadata#onUrlInput input->form-validation#validateForm"
              } %>
                  </div>
          
          <div class="hidden" data-link-metadata-target="duplicateWarning">
            <!-- Duplicate warning will be inserted here -->
          </div>
          
          <div class="hidden" data-link-metadata-target="loading">
          <div class="text-center py-4">
            <div class="inline-flex items-center">
              <%= inline_svg_tag "spinner.svg", class: "animate-spin -ml-1 mr-3 h-5 w-5 text-red-600" %>
              <span class="text-gray-600">Fetching link metadata...</span>
            </div>
          </div>
        </div>
        
        <div class="<%= post.link? && post.persisted? ? '' : 'hidden' %>" data-link-metadata-target="preview">
          <% if post.link? && post.persisted? %>
            <h4 class="text-sm font-medium text-gray-700 mb-2">Preview:</h4>
            <div class="bg-white border border-gray-300 rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
              <% if post.featured_image.attached? %>
                <div class="aspect-w-16 aspect-h-9">
                  <%= post_image_tag(post, size: :thumb, css_class: "w-full h-48 object-cover", alt: post.title) %>
                </div>
              <% end %>
              <div class="p-4">
                <h3 class="font-semibold text-lg mb-2"><%= post.title %></h3>
                <p class="text-gray-600 text-sm line-clamp-2"><%= post.summary.presence || 'No description available' %></p>
                <p class="text-blue-600 text-sm mt-2 truncate"><%= post.url %></p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div id="title-field" data-content-type-target="titleField">
      <%= form.label :title, class: "block text-sm font-bold text-black mb-2" %>
      <%= form.text_field :title, 
          class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 placeholder:text-gray-400", 
          placeholder: post.success_story? ? "Enter company or project name" : "Enter a descriptive title",
          data: { 
            "link-metadata-target": "title", 
            "content-type-target": "titleInput", 
            "form-validation-target": "requiredField", 
            "action": "input->form-validation#validateForm" 
          } %>
      <p class="mt-1 text-xs text-gray-400 hidden" data-content-type-target="linkTitleHint">Title will auto-populate from the link, but you can edit it</p>
    </div>
    
    <div id="logo-field" class="<%= 'hidden' unless post.success_story? %>" data-content-type-target="logoField">
      <%= form.label :logo_svg, "Company Logo (SVG)", class: "block text-sm font-bold text-black mb-2" %>
      <div class="space-y-4">
        <div class="w-full cursor-pointer <%= 'hidden' if post.persisted? && post.logo_svg.present? %>" 
             data-content-type-target="uploadArea"
             data-action="click->content-type#triggerFileUpload dragover->content-type#handleDragOver drop->content-type#handleDrop dragleave->content-type#handleDragLeave">
          <div class="w-full py-8 px-4 bg-white border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-red-400 hover:text-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500">
            <div class="flex flex-col items-center space-y-2">
              <%= inline_svg_tag "plus.svg", class: "w-8 h-8" %>
              <span class="text-base font-medium">Upload SVG Logo</span>
              <span class="text-sm text-gray-500">Click to browse or drag and drop</span>
            </div>
          </div>
        </div>
        
        <input type="file"
               accept="image/svg+xml,.svg"
               class="hidden"
               data-content-type-target="logoInput"
               data-action="change->content-type#handleSvgUpload">
        <%= form.hidden_field :logo_svg, data: { 
          "content-type-target": "svgContent", 
          "form-validation-target": "requiredField", 
          "action": "change->form-validation#validateForm" 
        } %>
        
        <div class="hidden" data-content-type-target="logoPreviewWrapper">
          <div class="relative bg-gray-50 p-6 rounded-lg border border-gray-200">
            <button type="button"
                    data-action="click->content-type#removeLogo"
                    class="absolute top-2 right-2 p-1 bg-white rounded-full shadow-md hover:shadow-lg transition-shadow cursor-pointer">
              <svg class="w-5 h-5 text-gray-600 hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
            <div class="flex justify-center items-center" data-content-type-target="logoPreview">
              <!-- SVG preview will be inserted here -->
            </div>
          </div>
        </div>
        
        <% if post.persisted? && post.logo_svg.present? %>
          <div data-content-type-target="logoPreviewWrapper">
            <div class="relative bg-gray-50 p-6 rounded-lg border border-gray-200">
              <button type="button"
                      data-action="click->content-type#removeLogo"
                      class="absolute top-2 right-2 p-1 bg-white rounded-full shadow-md hover:shadow-lg transition-shadow cursor-pointer">
                <svg class="w-5 h-5 text-gray-600 hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
              <div class="flex justify-center items-center" data-content-type-target="logoPreview">
                <%= raw post.logo_svg %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div id="image-field" class="<%= 'hidden' if post.success_story? %>" data-content-type-target="imageField">
      <%= form.label :featured_image, "Featured Image", class: "block text-sm font-medium text-gray-500 mb-2" %>
      
      <div class="space-y-4">
        <div class="w-full cursor-pointer <%= 'hidden' if post.persisted? && post.featured_image.attached? %>" 
             data-content-type-target="imageUploadArea"
             data-action="click->content-type#triggerImageUpload dragover->content-type#handleImageDragOver drop->content-type#handleImageDrop dragleave->content-type#handleImageDragLeave">
          <div class="w-full py-8 px-4 bg-white border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-red-400 hover:text-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500">
            <div class="flex flex-col items-center space-y-2">
              <%= inline_svg_tag "plus.svg", class: "w-8 h-8" %>
              <span class="text-base font-medium">Upload Featured Image</span>
              <span class="text-sm text-gray-500">Click to browse or drag and drop</span>
            </div>
          </div>
        </div>
        
        <%= form.file_field :featured_image,
            accept: "image/jpeg,image/jpg,image/png,image/webp,image/tiff,image/x-tiff",
            class: "hidden",
            data: { 
              "content-type-target": "imageInput",
              "action": "change->content-type#handleImageUpload",
              "max-size": Post::MAX_IMAGE_SIZE.to_s
            } %>
        <%= form.hidden_field :metadata_image_url, data: { "link-metadata-target": "imageUrl", "content-type-target": "metadataImageUrl" } %>
        
        <div class="hidden" data-content-type-target="imagePreviewWrapper">
          <div class="relative bg-gray-50 p-6 rounded-lg border border-gray-200">
            <button type="button"
                    data-action="click->content-type#removeImage"
                    class="absolute top-2 right-2 p-1 bg-white rounded-full shadow-md hover:shadow-lg transition-shadow cursor-pointer">
              <svg class="w-5 h-5 text-gray-600 hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
            <div class="flex justify-center items-center" data-content-type-target="imagePreview">
              <!-- Image preview will be inserted here -->
            </div>
            <div class="mt-4 text-center" data-content-type-target="imageInfo">
              <!-- File info will be inserted here -->
            </div>
          </div>
        </div>
        
        <% if post.persisted? && post.featured_image.attached? %>
          <div class="relative bg-gray-50 p-6 rounded-lg border border-gray-200" data-content-type-target="imagePreviewWrapper">
            <button type="button"
                    data-action="click->content-type#removeImage"
                    class="absolute top-2 right-2 p-1 bg-white rounded-full shadow-md hover:shadow-lg transition-shadow cursor-pointer">
              <svg class="w-5 h-5 text-gray-600 hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
            <div class="flex justify-center items-center">
              <%= post_image_tag(post, size: :medium, css_class: "max-w-full max-h-64 object-contain rounded", alt: post.title) %>
            </div>
            <div class="mt-4 text-center">
              <p class="text-sm text-gray-600"><%= post.featured_image.filename %></p>
              <p class="text-xs text-gray-500">Size: <%= number_to_human_size(post.featured_image.byte_size) %></p>
            </div>
          </div>
        <% end %>
        
        <%# Always include the remove flag, not just when image exists %>
        <%= form.hidden_field :remove_featured_image, value: "0", data: { "content-type-target": "removeImageFlag" } %>
      </div>
    </div>

    <div id="article-fields" class="<%= 'hidden' if post.link? %>" data-controller="markdown-preview" data-content-type-target="articleFields">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <div class="flex items-center justify-between mb-2">
            <%= form.label :content, "Content", class: "block text-sm font-bold text-black" %>
            <button type="button" class="lg:hidden text-sm text-red-600 hover:text-red-800" data-action="click->markdown-preview#togglePreview">
              Toggle Preview
            </button>
          </div>
          <%= form.text_area :content, rows: 20, 
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 font-mono text-sm placeholder:text-gray-400 resize-none", 
              placeholder: "Write your content here...",
              data: { 
                "markdown-preview-target": "input",
                "content-type-target": "contentInput",
                "form-validation-target": "requiredField",
                "action": "input->markdown-preview#updatePreview input->form-validation#validateForm"
              } %>
        </div>
        
        <div class="hidden lg:block" data-markdown-preview-target="previewContainer">
          <h4 class="text-sm font-medium text-gray-500 mb-2">Preview</h4>
          <div class="prose prose-sm max-w-none border border-gray-300 rounded-md p-4 bg-white overflow-y-auto" data-markdown-preview-target="preview">
            <p class="text-gray-400">Preview will appear here as you type...</p>
          </div>
        </div>
      </div>
      <p class="mt-2 text-xs text-gray-400">You can use Markdown formatting. Code blocks are supported with syntax highlighting.</p>
    </div>

    <% 
      # Load tags for existing posts
      existing_tags = if post.persisted? && post.tags.any?
        post.tags.to_a.map { |t| { id: t.id, name: t.name } }
      else
        []
      end
    %>

    <div id="tags-field" class="<%= 'hidden' if post.success_story? %>" data-controller="tag-input" data-content-type-target="tagsField" data-content-type-target="tagsInput" 
         data-tag-input-existing-tags-value='<%= existing_tags.to_json %>'
         data-tag-input-create-new-text-value="<%= t('posts.form.tags.create_new') %>"
         data-tag-input-placeholder-value="<%= t('posts.form.tags.placeholder') %>"
         data-tag-input-placeholder-with-tags-value="<%= t('posts.form.tags.placeholder_with_tags') %>">
      <%= form.label :tag_names, t('posts.form.tags.label'), class: "block text-sm font-medium text-gray-500 mb-2" %>
      <div class="relative">
        <div class="flex flex-wrap items-center gap-1 min-h-[42px] px-3 py-1.5 border border-gray-300 rounded-md focus-within:ring-3 focus-within:ring-red-500 cursor-text bg-white"
             data-tag-input-target="container">
          <!-- Tags will be rendered here inline with the input -->
          <div class="tag-input-wrapper flex-1 min-w-[150px]">
            <input type="text" 
                   class="w-full outline-none border-0 p-0 focus:ring-0 focus:outline-none focus:border-0 text-sm bg-transparent placeholder:text-gray-400"
                   placeholder="<%= post.tags.empty? ? t('posts.form.tags.placeholder') : t('posts.form.tags.placeholder_with_tags') %>"
                   data-tag-input-target="input"
                   data-action="input->tag-input#handleInput keydown->tag-input#handleKeydown">
          </div>
        </div>
        <%= form.hidden_field :tag_names, 
                              value: post.persisted? ? post.tags.to_a.map(&:name).join(',') : '', 
                              data: { "tag-input-target": "hiddenField" } %>
        
        <div class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto"
             data-tag-input-target="suggestions">
          <!-- Suggestions will be rendered here -->
        </div>
      </div>
      <p class="text-xs text-gray-400 mt-2"><%= t('posts.form.tags.help_text') %></p>
    </div>

    <div data-controller="markdown-preview">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <div class="flex items-center justify-between mb-2">
            <%= form.label :summary, "Summary", class: "block text-sm font-medium text-gray-500" %>
            <button type="button" class="lg:hidden text-sm text-red-600 hover:text-red-800" data-action="click->markdown-preview#togglePreview">
              Toggle Preview
            </button>
          </div>
          <%= form.text_area :summary, rows: 5,
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 font-mono text-sm placeholder:text-gray-400 resize-none", 
              placeholder: "Enter a brief summary of your post (optional). If left blank, an AI-generated summary will be created.",
              data: { 
                "markdown-preview-target": "input",
                "content-type-target": "summaryInput",
                "action": "input->markdown-preview#updatePreview",
                "link-metadata-target": "summary"
              } %>
        </div>
        
        <div class="hidden lg:block" data-markdown-preview-target="previewContainer">
          <h4 class="text-sm font-medium text-gray-500 mb-2">Preview</h4>
          <div class="prose prose-sm max-w-none border border-gray-300 rounded-md p-4 bg-white overflow-y-auto min-h-[120px]" data-markdown-preview-target="preview" style="height: 120px;">
            <p class="text-gray-400">Preview will appear here as you type...</p>
          </div>
        </div>
      </div>
      <p class="mt-1 text-xs text-gray-400">A 2-3 sentence summary that captures the key points. Leave blank to auto-generate.</p>
    </div>

    <div class="flex items-center justify-between" data-controller="publish-toggle">
      <div class="flex items-center space-x-2">
        <span class="text-sm font-medium <%= post.published? ? 'text-gray-500' : 'text-gray-900' %>" data-publish-toggle-target="draftLabel">
          Draft
        </span>
        <button type="button"
                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 <%= post.published? ? 'bg-red-600' : 'bg-gray-400' %>"
                role="switch"
                aria-checked="<%= post.published? %>"
                data-action="click->publish-toggle#toggle"
                data-publish-toggle-target="track">
          <span class="sr-only">Toggle publication status</span>
          <span aria-hidden="true"
                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out <%= post.published? ? 'translate-x-4' : 'translate-x-0' %>"
                data-publish-toggle-target="switch"></span>
        </button>
        <span class="text-sm font-medium <%= post.published? ? 'text-gray-900' : 'text-gray-500' %>" data-publish-toggle-target="publishLabel">
          Publish
        </span>
        <%= form.check_box :published, 
            class: "hidden", 
            data: { "publish-toggle-target": "checkbox" } %>
      </div>
      
      <div class="flex items-center space-x-4">
        <%= link_to "Cancel", "#{user_path(current_user)}#posts", class: "px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" %>
        <%= form.submit post.new_record? ? "Create Post" : "Update Post", 
            class: "px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",
            disabled: post.new_record?,
            data: { 
              "form-validation-target": "submitButton",
              "turbo-submits-with": post.new_record? ? "Creating..." : "Updating...", 
              disable_with: post.new_record? ? "Creating..." : "Updating..." 
            } %>
      </div>
    </div>
  </div>
<% end %> 